name: Build Live Image with Custom Kernel and Initrd

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4.1.7

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget live-build
        sudo apt-get install -y build-essential fakeroot libncurses5-dev libssl-dev ccache bison flex libelf-dev libudev-dev libpci-dev libiberty-dev debhelper dpkg-dev debootstrap gpg debian-archive-keyring

        #!/bin/bash -x
        # Patch to display boot menu for 10 seconds before booting
        sudo patch -p1 -N -d /usr/share/live/build/bootloaders/isolinux <patches/isolinux.cfg.patch

    - name: Configure live-build for Debian with Custom Kernel and Initrd
      run: |
        mkdir -p live-build
        cd live-build
        
        # Initialize live-build configuration
        lb config --distribution jammy --archive-areas "main contrib non-free non-free-firmware" --debian-installer live --firmware-chroot false

        # Create necessary directories
        mkdir -p config/packages.chroot config/package-lists config/hooks/normal config/includes.chroot/etc/default config/includes.chroot/lib

        # Create package list
        cat << EOF > config/package-lists/my.list.chroot
        efivar
        efibootmgr
        grub-efi-amd64
        EOF
        
        # Create GRUB default configuration
        echo 'GRUB_TIMEOUT=5' > config/includes.chroot/etc/default/grub

    - name: Build Debian Live ISO
      run: |
        cd live-build
        sudo lb clean
        sudo lb config
        sudo lb build
#      continue-on-error: true

    - name: Check for ISO file
      run: |
        if [ -f live-build/live-image-amd64.hybrid.iso ]; then
          echo "ISO file created successfully"
        else
          echo "Error: ISO file not created"
          ls -R live-build
          exit 1
        fi

    - name: Upload Live ISO
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: debian-live-custom-kernel-initrd.iso
        path: live-build/live-image-amd64.hybrid.iso

    - name: Clean up
      if: always()
      run: |
        cd live-build
        sudo lb clean
        sudo rm -rf chroot
